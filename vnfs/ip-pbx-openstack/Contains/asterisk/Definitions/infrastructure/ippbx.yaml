tosca_definitions_version: tosca_simple_yaml_1_0

description: IP PBX Openstack infrastructure

topology_template:
  inputs:
    instancename:
      type: string
    mgmt_network:
      type: string
    mgmt_security_group:
      type: string
    key_name:
      type: string
      default: default
    image:
      type: string
      default: ippbx
    flavor:
      type: string
      default: m1.small

  node_templates:

    # find mgmt network
    mgmt_network:
      type: os.ext.nodes.network.Network
      properties:
        network_name: { get_input: mgmt_network  }

    ippbx:
      type: os.ext.nodes.Compute
      properties:
        flavor: { get_input: flavor }
        image: { get_input: image }
        key_name: { get_input: key_name }
        user_data_format: RAW
        user_data: |
          #cloud-config
          manage_etc_hosts: true
          bootcmd:
           - [ sysctl, net.ipv4.ip_forward=1 ]
           - [ ip, link, set, ens4, up ]
           - [ dhclient, ens4 ]
           - [ sh, -c, echo "nameserver 8.8.8.8" > /etc/resolv.conf ]
          ssh_pwauth: True
          password: ubuntu
          chpasswd:
            list: |
              ubuntu:ubuntu
            expire: False

    ippbx_mgmt_port:
      type: os.ext.nodes.network.Port
      requirements:
        - binding:
            node: ippbx
        - link:
            node: mgmt_network
      properties:
        # is_default: true
        order: 2
        security_groups: 
          - { get_input: mgmt_security_group }

  outputs:

    mgmt_address:
      description: The mgmt IP address 
      value: { get_attribute: [ippbx_mgmt_port, ip_address] }

