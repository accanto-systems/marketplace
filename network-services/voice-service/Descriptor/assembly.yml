description: descriptor for voice-service
properties:
  deployment_location:
    type: string
    default: core
    required: true
  mgmt_infra_name:
    type: string
    default: mgmt
    required: true
  voice_network_id:
    read-only: true
    value: ${voice_infra.voice_network_id}
  voice_security_group_id:
    read-only: true
    value: ${voice_infra.voice_security_group_id}
  voice_service_access_ip:
    type: string
    read-only: true
    value: ${gateway.voice_address}
composition:
  voice_infra:
    properties:
      deploymentLocation:
        value: ${deployment_location}
      resourceManager:
        value: brent
    type: $lmctl:/contains:/infra:/descriptor_name
  voice_server:
    cluster:
      initial-quantity: 1
      minimum-nodes: 1
      maximum-nodes: 10
      scaling-increment: 1
    properties:
      deploymentLocation:
        value: ${deployment_location}
      gw_address:
        value: ${gateway.internal_address}
      voice_network:
        value: ${voice_infra.internal_network_id}
      voice_security_group:
        value: ${voice_infra.internal_security_group_id}
      mgmt_infra_name:
        value: ${mgmt_infra_name}
      voice_cidr:
        value: ${voice_infra.internal_cidr}
    type: assembly::ip-pbx::1.0
  gateway:
    properties:
      deploymentLocation:
        value: ${deployment_location}
      voice_network:
        value: ${voice_infra.voice_network_id}
      voice_security_group:
        value: ${voice_infra.voice_security_group_id}
      internal_network:
        value: ${voice_infra.internal_network_id}
      internal_security_group:
        value: ${voice_infra.internal_security_group_id}
      mgmt_infra_name:
        value: ${mgmt_infra_name}
    type: assembly::voip-gateway::1.0
references:
  mgmt_infra:
    properties:
      name:
        value: ${mgmt_infra_name}
    type: assembly::mgmt_infra::1.0

relationships:
  manageDispatchList:
    properties:
      ipaddr:
        value: ${source.voice_address}
      port:
        value: '5060'
    source-state: Active
    target-state: Active
    source-state-modifier: post
    target-state-modifier: post
    lifecycle:
      Create:
      - target.addToDispatchList
      Cease:
      - target.deleteFromDispatchList
    source-capabilities:
    - voice_server.poolNode
    target-requirements:
    - gateway.poolController
policies:
  scaleVoipServer:
    properties:
      scaleOut_threshold:
        value: 58
      scaleIn_threshold:
        value: 32
      smoothing:
        value: 3
    type: policy::scale
    metric: gateway.h_load
    target: voice_server

designerLayout:
  description: >-
    The following information is solely used to determine the presentation of
    this Assembly Design in the LM UI. It does not form part of
    operational/behavioural description of the Assembly and should not be edited
    directly.
  elements:
    voice_infra:
      x: 539.3331909179688
      y: 396.0000228881836
    mgmt_infra:
      x: 342
      y: 684
    assembly::voice-service::1.0:
      x: 0.00000762939453125
      y: 180
    voice_server:
      x: 1446.0000610351562
      y: 86.66666412353516
    gateway:
      x: 815.3333129882812
      y: 86.66667938232422
